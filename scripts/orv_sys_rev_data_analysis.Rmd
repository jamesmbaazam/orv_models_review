---
title: "Systematic review of outbreak response models"
author: "James Azam"
date: "01/06/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, message=FALSE}
#' load packages
library('tidyverse')
library('readr')
library('ggthemes')
library('scales')
library('janitor')
library('forcats')
library('stringr')
```


```{r echo=FALSE, message=FALSE}
#' Load the script that cleans the data and saves it; this should be run each time, just in case something has changed in the data cleaning process
source(normalizePath('./scripts/data_cleaning/orv_models_review_data_cleaning.R'))
```

# Exploratory Data Analysis
1. Publications per year
2. Distribution of collaborations across types (aggregated)
3. Countries/settings being studied (author affiliation vs country studied)


What science is being inferred from models?

1. Impact of vaccination (human diseases vs FMD); analyse with and without Influenza
2. What diseases are being studied (to understand vaccine impact)
3. Which interventions are being studied?

```{r echo=FALSE}

pubs_per_year <- review_data_compact_cleaned %>% 
  filter(disease != 'FMD') %>% 
  count(publication_year)

pubs_per_year_bar_plot <- ggplot(data = pubs_per_year) + 
  geom_bar(aes(x = publication_year, 
               y = n
               ), 
           stat = 'identity', 
           color = 'black',
           fill = 'tomato3') +
  scale_x_continuous(breaks = seq(1970, 2020, 5),
                     labels = seq(1970, 2020, 5)
                     ) +
  scale_y_continuous(breaks = seq(0, 26, 2),
                     labels = seq(0, 26, 2)
                     ) +
  theme_minimal()

plot(pubs_per_year_bar_plot)

```

```{r echo=FALSE}
modelling_objectives_by_outbreak_type_df <- review_data_compact_cleaned %>% 
  select(objectives, outbreak_type) 

modelling_objectives_by_outbreak_type <- modelling_objectives_by_outbreak_type_df %>% 
  count(objectives, outbreak_type)

modelling_objectives_n_timing_plot <- ggplot(data = modelling_objectives_by_outbreak_type) + 
  geom_bar(aes(y = n,
               x = objectives,
               fill = outbreak_type
               ),
           stat = 'identity', 
           position = position_dodge(),
           width = 0.6
           ) +
  theme(axis.text.x = element_text(angle = 90, 
                                  # hjust = 1,
                                   vjust = 0.5
                                   )
        )

plot(modelling_objectives_n_timing_plot)
```



```{r table2, echo=FALSE, results = 'asis'} 
max_pub_year <- review_data_wide_cleaned %>% 
    count(publication_year) %>% 
    filter(n == max(n)) 

disease_with_max_pubs <- review_data_wide_cleaned %>% 
    count(disease) %>% 
    filter(n == max(n)) 

country_most_studied <- review_data_wide_cleaned %>% 
    count(country_studied) %>% 
    filter(n == max(n)) 

```

# Primary objectives 

1. Is modelling being used to inform outbreak response policy-making? 
+ How are the results distributed according to collaboration type?

Note that we do not include FMD in all the primary analyses. We only use it for secondary comparisons.

```{r echo=FALSE}
#' 1A. Select variables relevant to the policy-making ('pm') analysis. 
pm_data <- policy_making_data

# 1B. Create the author affiliation types and reword the string NA
pm_data_mutated <- pm_data %>%
  arrange(publication_year) %>%
  mutate(
    author_affiliation_type = str_replace_all(author_affiliation_type, ' ', ' + '),
    author_in_country_studied = if_else(author_in_country_studied == 'NA', 'not_applicable',
                                        author_in_country_studied
                                        )
    )



#' Count by affiliation type and make a barplot
pm_data_affiliation_aggregated <- pm_data_mutated %>% 
    mutate(author_affiliation_type = as_factor(author_affiliation_type)) %>% 
    count(author_affiliation_type) %>% 
    mutate(perc = round(n/sum(n)*100, 1)) %>% 
    arrange(desc(n))
 
```

+ What has been the trend in collaboration over the years?

```{r echo=FALSE}
    
affiliation_type_aggregated_barplot <- pm_data_affiliation_aggregated %>%
    ggplot() + geom_bar(aes(x = reorder(author_affiliation_type, perc),
                            y = perc,
                            fill = factor(author_affiliation_type)
                            ),
                        stat = 'identity',
                        color = 'black'
                        ) +
    scale_y_continuous(breaks = seq(0, 60, 5),
                       labels = seq(0, 60, 5)
                       ) +
    labs(title = 'Percentage of studies per collaboration type', 
         x = '', 
         y = 'Percent') + 
  coord_flip() +
  theme_minimal() +
  theme(legend.position = 'none')

plot(affiliation_type_aggregated_barplot)

```

```{r echo=FALSE}
#' Count the number of each author affiliation type per year (including FMD)
collab_type_by_year <- pm_data_mutated %>% 
  arrange(publication_year) %>%
  mutate(collab_type = as_factor(if_else(author_affiliation_type == 'academic_institutions', 
                                         'Academic', 
                                         'Other collabs')
                                 )
  ) %>% 
  count(publication_year, 
        collab_type, 
        name = 'total_publications'
        )


collab_type_by_year_mod <- collab_type_by_year %>% 
  mutate(year_aggreg = as_factor(ifelse(publication_year < 2005, '<2005', publication_year)))

collab_type_by_year_mod_count <- collab_type_by_year_mod %>% 
  count(year_aggreg, 
        collab_type, 
        name = 'total_publications'
        )

```

A bar chart with each bar representing a proportion of the total publications for that year.

```{r echo=FALSE}

collab_type_by_year_plot <- ggplot(data = collab_type_by_year_mod_count) + 
  geom_bar(aes(x = year_aggreg,
               y = total_publications,
               fill = collab_type
               ),
           color = 'black',
           stat = 'identity',
           position = position_fill()  
             ) +
  scale_fill_manual(values = c('tan1', 'turquoise1')) +
  scale_x_continuous(breaks = seq(1971, 2020, 5),
                     labels = seq(1971, 2020, 5)
                     ) +
  labs(title = 'Proportion of publications by collaboration type',
       x = 'Year',
       y = 'Proportion of publications',
       fill = 'Collaboration type' 
         ) +
  theme_minimal()

plot(collab_type_by_year_plot)

```

2. Is vaccination the most effective when compared to other single interventions?


```{r echo=FALSE}
#' Select the variables related to vaccination 
vax_vars_wide_data <- vax_impact_data %>% 
  filter(vax_modelled_with_non_vax == 'yes', 
         disease != 'FMD'
         )

#count the impact categories
vax_impact_categories <- vax_vars_data_compact %>% 
  count(is_vax_effective) %>% 
  mutate(perc = n/sum(n)*100) %>% 
  arrange(n)
```
```{r echo=FALSE}
vax_impact_plot <- ggplot(data = vax_impact_categories) + 
  geom_bar(
    aes(x = is_vax_effective, 
        y = n,
        fill = is_vax_effective
        ),
    stat = 'identity',
    width = 0.25
    ) +
  scale_y_continuous(breaks = seq(0, 
                                  max(vax_impact_categories$n),
                                  2
                                  ),
                     labels = seq(0, 
                                max(vax_impact_categories$n),
                                2
                                )
                     ) +
  scale_x_discrete(breaks = c('no', 
                              'yes', 
                              'the_outcomes_were_inconclusive'
                              ), 
                   labels = c('no' = 'no', 
                              'yes' = 'yes', 
                              'the_outcomes_were_inconclusive' = 'inconclusive'
                              )
                   ) +
  scale_fill_discrete(name = 'Vaccine impact',
                      labels = c('no', 
                                 'inconclusive',
                                 'yes'
                      )
                      ) +
  labs(x = 'Vaccine is most impactful',
       y = 'Number of studies'
       ) +
  theme_minimal()

plot(vax_impact_plot)

```

