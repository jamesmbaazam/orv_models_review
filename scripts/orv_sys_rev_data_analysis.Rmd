---
title: "Systematic review of outbreak response models"
author: "James Azam"
date: "01/06/2021"
output:
  word_document:
    keep_md: yes
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, message=FALSE}
#' load packages
library('tidyverse')
library('readr')
library('ggthemes')
library('scales')
library('janitor')
library('forcats')
library('stringr')
library('countrycode')
library('bib2df')
library('conflicted')

#resolve package function conflicts
conflict_prefer('filter', 'dplyr')
conflict_prefer('select', 'dplyr')
conflict_prefer('kable', 'knitr')
```


```{r echo=FALSE}
# Sets the working directory for subsequent chunks, but not this chunk
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Load the script that cleans the data and saves it; 
# this should be run each time, just in case something has changed in the data cleaning process;
# The script clears the environment after cleaning the data
source('./scripts/data_cleaning/orv_models_review_data_cleaning.R')

#' Load the cleaned data 

long_data <- read_rds(normalizePath('./data/final_data/cleaned_data/review_data_long_cleaned.rds'))

compact_data <- read_rds(normalizePath('./data/final_data/cleaned_data/review_data_compact_cleaned.rds'))

compact_data_with_citation_keys <- read_rds(normalizePath('./data/final_data/cleaned_data/compact_data_with_citation_keys_cleaned.rds'))
  

# Remove the FMD papers (NB: We only use the FMD papers for comparison)
long_data_no_fmd <- long_data %>% filter(disease != 'fmd') 

compact_data_no_fmd <- compact_data %>% filter(disease != 'fmd') 


#' 1. Author-affiliation and country studied/contextual knowledge (Policy-making related questions)
pm_data <- long_data_no_fmd %>% 
  select(
        title,
        publication_year,
        objectives,
        author_affiliation_type,
        disease,
        country_studied,
        author_in_country_studied,
        outbreak_type,
        modelling_timing,
        data_used,
        data_available
        )  

#' 2. Vaccine-impact (Questions related to the Science done)
#' Select the variables related to vaccination modelling
vax_impact_data <- compact_data_no_fmd %>% 
    select(title, 
           publication_year,
           disease,
           outbreak_type,
           intervention_modelled,
           vax_modelled_with_non_vax,
           is_vax_effective,
           outcome_measured
    ) 


```


# Exploratory Data Analysis
1. Publications per year
2. Distribution of collaborations across types (aggregated)
3. Countries/settings being studied (author affiliation vs country studied)


What science is being inferred from models?

1. Impact of vaccination (human diseases vs FMD); analyse with and without Influenza
2. What diseases are being studied (to understand vaccine impact)
3. Which interventions are being studied?

```{r echo=FALSE}

pubs_per_year <- compact_data_no_fmd %>% 
  mutate(publication_year = as.numeric(publication_year)) %>% 
  count(publication_year) 

pubs_per_year_bar_plot <- ggplot(data = pubs_per_year) + 
  geom_bar(aes(x = publication_year, 
               y = n
               ), 
           stat = 'identity', 
           color = 'black',
           fill = 'tomato3') +
  scale_y_continuous(breaks = seq(0, 30, 2),
                     labels = seq(0, 30, 2)
                     ) +
  labs(x = 'Year of publication', y = 'Number of papers') +
  theme_minimal()

plot(pubs_per_year_bar_plot)

```

```{r echo=FALSE}
#Find the uniques entries
modelling_objectives_unique_entries <- long_data_no_fmd %>% 
  select(title, objectives) %>% 
  distinct() 

#count the number of studies per objective type
modelling_objectives_count <- modelling_objectives_unique_entries %>% 
  count(objectives, name = 'num_of_studies')

#Print a table of the results
knitr::kable(modelling_objectives_count,
             col.names = c('Objective type',
                           'Number of studies'
                           ),
             caption = 'Number of studies per objective type'
             )

#Find the unique entries 
outbreak_types_unique_entries <- long_data_no_fmd %>% 
  select(title, outbreak_type) %>% 
  distinct() 

#Count the number of studies per outbreak type  
outbreak_types_count <- outbreak_types_unique_entries %>% 
  count(outbreak_type, name = 'num_of_studies')
  

#Print a table of the results
knitr::kable(outbreak_types_count,
             col.names = c('Outbreak type',
                           'Number of studies'
                           ),
             caption = 'Number of studies per outbreak type'
             )


#Find the number of unique entries per objective type and outbreak type combination  
modelling_objectives_by_outbreak_type_unique_entries <- long_data_no_fmd %>% 
  select(title, objectives, outbreak_type) %>% 
  group_by(title) %>% 
  distinct() %>% 
  ungroup() 

modelling_objectives_by_outbreak_type_count <- modelling_objectives_by_outbreak_type_unique_entries %>% 
  count(objectives, outbreak_type, name = 'num_of_studies') %>% 
  arrange(desc(num_of_studies))

knitr::kable(modelling_objectives_by_outbreak_type_count, 
             col.names = c('Objective type', 
                           'Outbreak type', 
                           'Number of studies'
                           ),
             caption = 'Number of studies per objective and outbreak type'
             ) 

# modelling_objectives_n_timing_plot <- ggplot(data = modelling_objectives_by_outbreak_type_count) +
#   geom_bar(aes(y = n,
#                x = objectives,
#                fill = outbreak_type
#                ),
#            stat = 'identity',
#            position = position_dodge(),
#            width = 0.6
#            ) +
#   labs(y = 'Number of papers') +
#   scale_x_discrete(labels = c('both' = 'Prospective + Retrospective',
#                               'future' = 'Prospective',
#                               'past' = 'Retrospective')
#                    ) +
#   theme_minimal()
# 
# plot(modelling_objectives_n_timing_plot)
```



```{r table2, echo=FALSE, results = 'asis'} 
#Year with the highest publications
max_pub_year <- compact_data_no_fmd %>% 
    count(publication_year, sort = T) %>% 
    filter(n == max(n)) 

#Tally of how many times each disease was studied during the period
disease_studied_count <- long_data_no_fmd %>% 
  group_by(disease) %>% 
  distinct(title) %>% 
  count(disease, name = 'num_of_studies', sort = T) %>%
  ungroup() 

knitr::kable(disease_studied_count, col.names = c('Disease', 'Number of times'))

# Disease most studied
disease_studied_most <- disease_studied_count %>% 
  filter(num_of_studies == max(num_of_studies)) 

knitr::kable(disease_studied_most)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}

#Tally of how many times and percentage of times each COUNTRY has been studied
countries_studied_by_count <- long_data_no_fmd %>% 
    group_by(country_studied) %>%
    distinct(title) %>% 
    count(country_studied, name = 'num_of_studies', sort = T) %>% 
    ungroup(country_studied) %>% 
    mutate(country_studied = as_factor(country_studied), 
           percentage = round(num_of_studies/sum(num_of_studies)*100, 1)
           )

#'Modify the data frame to lump together all countries with less than some number of studies as 'other' and recalculate the percentage studied
countries_studied_by_count_aggregated <- countries_studied_by_count %>% 
  mutate(country_studied_aggreg = if_else(num_of_studies < 9, 
                                          'other', 
                                          as.character(country_studied)
                                          )
         ) %>% 
  group_by(country_studied_aggreg) %>%
  summarise(num_of_studies = sum(num_of_studies),
            percentage = sum(percentage),
            .groups = 'drop'
            ) %>% 
  arrange(desc(percentage)) %>% 
  mutate(country_studied_aggreg = as_factor(country_studied_aggreg))

#Print the results
knitr::kable(countries_studied_by_count_aggregated, 
             col.names = c('Country', 
                           'Number of studies', 
                           'Percentage'
                           ),
             caption = 'Number/percentage of studies per country'
             )
 



#Tally of how many times and percentage of times each CONTINENT has been studied
continents_studied_by_count <- countries_studied_by_count %>% 
  mutate(continent_studied = countrycode(country_studied, 
                                          destination = 'continent',
                                          origin = 'iso2c',
                                          nomatch = NULL #if there is no match, keep the original
                                          )
         ) %>% 
  mutate(continent_studied = str_to_lower(continent_studied)
         ) %>% 
  mutate(continent_studied = case_when(str_detect(continent_studied, 'asia') == T ~ 'asia', 
                                         str_detect(continent_studied, 'africa') == T ~ 'africa', 
                                         TRUE ~ continent_studied
                                       )
           ) %>% 
  group_by(continent_studied) %>%
  summarise(num_of_studies = sum(num_of_studies), 
            percentage = sum(percentage),
            .groups = 'drop'
            ) %>% 
  arrange(desc(percentage))

#Print the results
knitr::kable(continents_studied_by_count, 
             col.names = c('Continent', 
                           'Number of studies', 
                           'Percentage'
                           ),
             caption = 'Number/percentage of studies per continent'
             )
 
#Find the country most studied but first remove the hypothetical countries 
countries_studied_most <- countries_studied_by_count %>% 
    filter(country_studied != 'none') %>%
    filter(num_of_studies == max(num_of_studies))

#Print the result as a table    
knitr::kable(countries_studied_most, 
             col.names = c('Country', 
                           'Number of studies', 
                           'Percentage'
                           ),
             caption = 'Most studied country'
             )

#Find the continent most studied but first remove the hypothetical countries
continent_studied_most <- continents_studied_by_count %>% 
    dplyr::filter(continent_studied != 'none') %>% 
    filter(num_of_studies == max(num_of_studies))


#Print the result as a table      
knitr::kable(continent_studied_most,
             col.names = c('Continent', 
                           'Number of studies',
                           'Percentage'
                           ),
             caption = 'Most studied continent'
             )


#Count the 
continents_studied_by_count <- continents_studied_by_count %>% 
  filter(continent_studied != 'none') %>% 
  filter(continent_studied != 'global') %>% 
  filter(continent_studied != 'northern_hemisphere') %>% 
  group_by(continent_studied) %>% 
  summarise(num_of_studies = sum(num_of_studies )) %>% 
  ungroup() %>% 
  mutate(percentage = round(num_of_studies/sum(num_of_studies)*100, 1))


continent_studied_most_plot <- ggplot(data = continents_studied_by_count) + 
  geom_bar(aes(x = reorder(continent_studied, num_of_studies), 
               y = num_of_studies 
               ),
           width = 0.5,
           stat = 'identity',
           fill = 'darkslategray4', 
           color = 'black'
           ) +
  scale_y_continuous(breaks = seq(0, 70, 10), 
                     labels = seq(0, 70, 10)
                     ) +
  labs(x = 'Continent', y = 'Number of papers')
  
plot(continent_studied_most_plot)

knitr::kable(continents_studied_by_count %>% arrange(percentage),
             col.names = c('Continent',
                           'Number of papers',
                           'Percentage'
                           ),
             caption = 'Number/percent of studies by continent'
             )

```

Other summaries
```{r echo=FALSE}
knitr::kable(tibble(max_pub_year = max_pub_year$publication_year, 
                    disease_with_max_pubs = disease_studied_most$disease,
                    country_most_studied = countries_studied_most$country_studied
                    )
             )
```



# Primary objectives 

1. Is modelling being used to inform outbreak response policy-making? 
+ How are the results distributed according to collaboration type?

Note that we do not include FMD in all the primary analyses. We only use it for comparisons, where necessary.

```{r echo=FALSE}
# 1B. Create the collaboration types and reword the string NA
collab_type_data <- compact_data_no_fmd %>%
  select(c(title, publication_year, author_affiliation_type, author_in_country_studied)) %>% 
  mutate(publication_year = as.numeric(publication_year), 
         author_in_country_studied = as.character(author_in_country_studied)) %>% 
  arrange(publication_year) %>%
  mutate(
    author_affiliation_type = str_replace_all(author_affiliation_type, ' ', ' + '),
    author_in_country_studied = if_else(author_in_country_studied == 'NA', 'not_applicable',
                                        author_in_country_studied
                                        )
    ) 



#' Count by collaboration types and make a bar plot
collab_types_count <- collab_type_data %>%
    count(author_affiliation_type) %>% 
    mutate(author_affiliation_type = as_factor(author_affiliation_type))

knitr::kable(collab_types_count)
```

+ What has been the trend in collaboration over the years?

```{r echo=FALSE, warning=FALSE, message=FALSE}
    
collap_types_count_barplot <- collab_types_count %>%
    ggplot() + geom_bar(aes(x = reorder(author_affiliation_type, n),
                            y = n
                            ),
                        stat = 'identity',
                        color = 'black'
                        ) +
    scale_y_continuous(breaks = seq(0, 140, 20),
                       labels = seq(0, 140, 20)
                       ) +
    labs(title = 'Number of studies per collaboration type', 
         x = '', 
         y = 'Number of studies') + 
  coord_flip() +
  theme_minimal() +
  theme(legend.position = 'none')

plot(collap_types_count_barplot)

knitr::kable(collab_types_count, 
             col.names = c('Collaboration type', 'Number of publications'),
             caption = 'Number of publications per collaboration type'
             )

```

Proportions of the total publications by collaboration type (academic only versus others).

```{r echo=FALSE}
#' Count the number of each author affiliation type per year (including FMD)
collap_types_by_year <- compact_data_no_fmd %>% 
  mutate(year_aggreg = as.numeric(ifelse(publication_year < 2006, 2005, publication_year
                                         )
                                  ), 
         collab_type = as_factor(if_else(author_affiliation_type == 'academic_institutions', 
                                         'Academic only', 
                                         'Other collaborations')
                                 )
         ) %>% 
  count(year_aggreg, 
        collab_type, 
        name = 'total_publications'
        )

#knitr::kable(collap_types_by_year)


#The plot
# Modify the x-axis labels to account for the lumping of the years from 2005 and below
x_axis_labels <- as.character(seq(2005, 2020, 2))

x_axis_labels[1] <- '1970-2005'



collab_type_by_year_plot <- ggplot(data = collap_types_by_year) + 
  geom_bar(aes(x = year_aggreg,
               y = total_publications,
               fill = collab_type
               ),
           color = 'black',
           stat = 'identity',
           position = position_fill(reverse = TRUE)  
             ) +
  scale_fill_manual(values = c('tan1', 'turquoise1')) +
  scale_x_continuous(breaks = seq(2005, 2020, 2),
                     labels = x_axis_labels
                     ) +
  labs(title = 'Publications per collaboration type over time',
       x = 'Year',
       y = 'Proportion of publications',
       fill = 'Collaboration type' 
         ) +
  theme_minimal(base_size = 12)

plot(collab_type_by_year_plot)

```

Plot of academic collaborations versus other collaborations not involving academics.

```{r echo=FALSE}

academic_collabs_versus_others <- compact_data_no_fmd %>% 
  filter(author_affiliation_type != 'academic_institutions') %>% 
  mutate(year_aggreg = as.numeric(ifelse(publication_year < 2006, 2005, publication_year
                                         )
                                  ), 
         collab_type = as_factor(if_else(str_detect(author_affiliation_type, 'academic_institutions'), 
                                         'Academic', 
                                         'Other'
                                         )
                                 )
         ) %>% 
  count(year_aggreg, 
        collab_type, 
        name = 'total_publications'
        )


#plot the result
academic_collabs_trend <- ggplot(data = academic_collabs_versus_others) + 
  geom_bar(aes(x = year_aggreg,
               y = total_publications,
               fill = collab_type
               ),
           color = 'black',
           stat = 'identity',
           position = position_fill(reverse = TRUE)  
             ) +
  scale_fill_manual(values = c('tan1', 'turquoise1')) +
  scale_x_continuous(breaks = seq(2005, 2020, 2),
                     labels = x_axis_labels
                     ) +
  labs(title = 'Academic and other collaborations over time',
       x = 'Year',
       y = 'Proportion of publications',
       fill = 'Collaboration type' 
         ) +
  theme_minimal(base_size = 12)

plot(academic_collabs_trend)


#Number of each collaboration type

```

2. Is vaccination the most effective when compared to other single interventions?


```{r echo=FALSE}
#count the impact categories
vax_impact_categories <- compact_data_no_fmd %>% 
  filter(vax_modelled_with_non_vax == 'yes') %>% 
  count(is_vax_effective, 
        name = 'num_of_studies', 
        sort = T
        ) 

#Print the results
knitr::kable(vax_impact_categories, 
             col.names = c('Vaccination is most impactful', 
                           'Number of studies'
                           ),
             caption = 'Studies\' conclusions about impact of vaccination'
             )

```


```{r echo=FALSE, eval=FALSE}
vax_impact_plot <- ggplot(data = vax_impact_categories) + 
  geom_bar(
    aes(x = is_vax_effective, 
        y = n,
        fill = is_vax_effective
        ),
    stat = 'identity',
    width = 0.25
    ) +
  scale_y_continuous(breaks = seq(0, 
                                  max(vax_impact_categories$n),
                                  2
                                  ),
                     labels = seq(0, 
                                max(vax_impact_categories$n),
                                2
                                )
                     ) +
  scale_x_discrete(breaks = c('no', 
                              'yes', 
                              'the_outcomes_were_inconclusive'
                              ), 
                   labels = c('no' = 'No', 
                              'yes' = 'Yes', 
                              'the_outcomes_were_inconclusive' = 'Inconclusive'
                              )
                   ) +
  scale_fill_discrete(name = 'Vaccine impact',
                      labels = c('No', 
                                 'Inconclusive',
                                 'Yes'
                      )
                      ) +
  labs(x = 'Vaccination is most impactful single intervention',
       y = 'Number of studies'
       ) +
  theme_minimal(base_size = 12)

plot(vax_impact_plot)

```

How many times each disease has been studied.

```{r echo=FALSE}
#count the number of unique diseases studied
disease_studied <- long_data_no_fmd %>% 
    group_by(disease) %>% 
    distinct(title) %>% 
    count(disease, sort = TRUE, name = 'num_of_studies') %>% 
  mutate(disease = as_factor(disease))


diseases_plot <- ggplot(data = disease_studied) + 
    geom_bar(aes(x = disease, 
                 y = n
                 ), 
             stat = 'identity',
             fill = 'dodgerblue3',
             color = 'black'
             ) + 
    scale_y_continuous(breaks = seq(0, 140, 10),
                       labels = seq(0, 140, 10)
                       ) +
    coord_flip(expand = FALSE) +
    labs(x = 'Disease', y = 'Number of studies') +
    theme_minimal(base_size = 12)


plot(diseases_plot)
```


How many times each intervention type has been modelled.

```{r echo=FALSE}
#count the number of unique interventions modelled
interventions_unique_entries <- long_data_no_fmd %>% 
  group_by(title) %>% 
  distinct(intervention_modelled) %>% 
  ungroup()

interventions_count <- interventions_unique_entries %>% 
  group_by(intervention_modelled) %>% 
  count(intervention_modelled, name = 'num_of_studies', sort = T) %>% 
  ungroup() %>% 
  filter(intervention_modelled != 'e.g.') %>% 
  filter(intervention_modelled != 'various')
    

interventions_count_plot <- ggplot(data = interventions_count) + 
  geom_bar(aes(x = intervention_modelled, 
               y = num_of_studies), 
           stat = 'identity',
           fill = 'darkslategray2',
           color = 'black'
           ) +
  coord_flip() +
  theme_minimal()

plot(interventions_count_plot)

knitr::kable(interventions_count)

```

How many times each outcome/metric has been used

```{r echo=FALSE}
#count the number of unique outcomes measured
outcomes_unique_entries <- long_data_no_fmd %>% 
  group_by(title) %>% 
  distinct(outcome_measured) %>% 
  ungroup()
  
#Count the number of studies 
outcomes_count <- outcomes_unique_entries %>% 
  group_by(outcome_measured) %>% 
  count(outcome_measured, name = 'num_of_studies', sort = T) %>% 
  ungroup() %>% 
  filter(outcome_measured != 's') 

knitr::kable(outcomes_count)

#Plot the result
outcome_count_plot <- ggplot(data = outcomes_count) + 
  geom_point(aes(x = reorder(outcome_measured, 
                             num_of_studies), 
               y = num_of_studies
               ), 
           stat = 'identity',
           color = 'darkslategray4'
           ) +
  coord_flip() +
  theme_minimal()

plot(outcome_count_plot)


```


Model structure

```{r echo=FALSE}
#Keep only the unique entries 
model_structure_unique_entries <- long_data_no_fmd %>% 
  group_by(title) %>% 
  distinct(model_structure) %>% 
  ungroup()

#Count the number of studies
model_structure_unique_count <- model_structure_unique_entries %>%
    group_by(model_structure) %>% 
    count(model_structure, name = 'num_of_studies') 

#Print the table
knitr::kable(model_structure_unique_count)

```

Model parametrization & validation

```{r}
#Keep only the unique entries
parametrization_and_validation_count <- compact_data_no_fmd %>% 
  mutate(parametrization = str_replace(parametrization, ' ', ' + '), 
         validation = str_replace(validation, ' ', ' + ')
         ) %>% 
  count(parametrization, 
        validation, 
        name = 'num_of_studies'
        ) %>% 
  group_by(parametrization) %>% 
  arrange(desc(num_of_studies), .by_group = T)   

#Print the table
knitr::kable(parametrization_and_validation_count)

```

Sensitivity analyses

```{r}
#Keep only the unique entries
sensitivity_analysis_unique_entries <- long_data_no_fmd %>% 
  group_by(title) %>% 
  distinct(sensitivity_analysis) %>% 
  ungroup()

#Count the number of studies
sensitivity_analysis_count <- sensitivity_analysis_unique_entries %>% 
  count(sensitivity_analysis, name = 'num_of_studies') 

#Print the table
knitr::kable(sensitivity_analysis_count)

```

Code and data availability
```{r}
#Keep only the unique entries
code_and_data_availability_unique_entries <- long_data_no_fmd %>% 
  group_by(title) %>% 
  distinct(data_used, data_available) %>% 
  ungroup() %>% 
  filter(data_used != 'no') 

#Count the number of studies
code_and_data_availability_count <- code_and_data_availability_unique_entries %>% 
  count(data_used, data_available, name = 'num_of_studies')

#Print the results
knitr::kable(code_and_data_availability_count)



```

